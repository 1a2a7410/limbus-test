<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>림버스</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg:#f7f7fb; --card:#ffffff; --fg:#1a1a1a; --muted:#667085; --border:#e7e7ef; --primary:#1f1f3a; --accent:#4b61ff; --sold:#c62828; }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { font-family: 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: linear-gradient(180deg,#fafafe,#f6f7fc); color:var(--fg); }
  .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
  header { position: sticky; top: 0; backdrop-filter: blur(6px); background: rgba(250,250,254,.8); border-bottom: 1px solid var(--border); z-index: 10; }
  .hdr-in { display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 14px 24px; }
  h1 { font-size: clamp(28px, 3vw, 40px); margin: 0; letter-spacing: .5px; }
  .help-btn { border:1px solid var(--accent); background: var(--accent); color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
  .toolbar { display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; padding: 12px 24px; }
  .filters { display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
  #selected-items { font-size:14px; color:var(--muted); min-height: 28px; }
  .btn { padding:10px 16px; border:1px solid var(--primary); background:var(--primary); color:#fff; border-radius:10px; cursor:pointer; font-weight:700; }
  .btn.secondary { background:#fff; color:var(--primary); }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  .input, .select { padding:10px 12px; border:1px solid var(--border); border-radius:10px; min-width: 160px; background:#fff; }
  .check { display:flex; gap:6px; align-items:center; font-size:14px; color:#384055; }
  #items { display:grid; gap:12px; margin: 12px auto 24px; max-width: 1000px; grid-template-columns: repeat(2, 1fr); }
  @media (min-width: 640px) { #items { grid-template-columns: repeat(3, 1fr); } }
  @media (min-width: 1024px) { #items { grid-template-columns: repeat(4, 1fr); } }
  .card { border:1px solid var(--border); border-radius:14px; padding:10px; text-align:center; cursor:pointer; transition: transform .1s ease, box-shadow .2s ease; background:var(--card); }
  .card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(25,25,60,.06); }
  .card img { width:100%; height: 90px; object-fit:cover; border-radius:10px; }
  @media (min-width:640px){ .card img { height: 120px; } }
  @media (min-width:1024px){ .card img { height: 150px; } }
  .name { margin-top:8px; font-size:14px; font-weight:600; }
  .selected { outline: 3px solid #7f8cff; outline-offset: 2px; }
  #results { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:16px; margin: 18px auto 48px; }
  .account { position:relative; border:1px solid var(--border); border-radius:16px; padding:14px; background:var(--card); text-align:left; box-shadow: 0 8px 20px rgba(25,25,60,.04); }
  .account h3 { margin:0 0 8px; font-size:16px; }
  .price { font-weight:800; color:#1c3; }
  .thumbs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
  .thumbs img { width:56px; height:56px; object-fit:cover; border-radius:10px; border:1px solid #eee; }
  .chip { display:inline-block; border:1px solid #ddd; border-radius:999px; padding:4px 10px; margin:2px; font-size:12px; background:#fafafa; }
  .soldout::after { content: "판매완료"; position:absolute; top:12px; right:-10px; background: var(--sold); color:#fff; font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; transform: rotate(6deg); }
  .sold-dim { opacity:.55; filter: grayscale(0.2); }
  .modal-backdrop { position:fixed; inset:0; background:rgba(16,18,36,.55); display:none; align-items:center; justify-content:center; padding:24px; z-index:100; }
  .modal { width: min(820px, 96vw); background:var(--card); border-radius:16px; border:1px solid var(--border); padding:16px; box-shadow: 0 24px 40px rgba(20,20,60,.18); }
  .modal header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .modal .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:12px; }
  .modal .tile { border:1px solid var(--border); border-radius:12px; padding:8px; text-align:center; background: #fff; }
  .modal .tile img { width:100%; height:120px; object-fit:cover; border-radius:10px; }
  .help-list { line-height: 1.75; color:#384055; font-size: 14.5px; padding-left: 20px; }
</style>
</head>
<body>
  <header>
    <div class="hdr-in">
      <h1 id="game-title"></h1>
      <button id="help-btn" class="help-btn" type="button">설명서</button>
    </div>
    <div class="toolbar">
      <div id="selected-items"></div>
      <div class="filters">
        <input id="uid-input" class="input" type="search" inputmode="numeric" placeholder="UID 검색" />
        <label class="check"><input id="hide-sold" type="checkbox"> 판매완료 숨기기</label>
        <select id="sort-filter" class="select" title="정렬">
          <option value="">정렬 없음</option>
          <option value="price_desc">가격 높은 순</option>
          <option value="price_asc">가격 낮은 순</option>
          <option value="count_desc">캐릭터 많은 순</option>
          <option value="count_asc">캐릭터 적은 순</option>
        </select>
        <button id="search-btn" class="btn" type="button" disabled>검색</button>
        <button id="clear-btn" class="btn secondary" type="button">선택 해제</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="items"></div>
    <div id="results"></div>
  </main>

  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header>
        <h2 id="detail-title" style="margin:0;font-size:18px;"></h2>
        <button id="close-modal" class="btn secondary" type="button">닫기</button>
      </header>
      <p id="detail-desc" style="margin-top:0;color:#555;"></p>
      <p id="detail-price" class="price" style="margin-top:0;"></p>
      <div id="detail-grid" class="grid"></div>
    </div>
  </div>

  <div id="help-backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header>
        <h2 style="margin:0;font-size:18px;">구매 가이드</h2>
        <button id="close-help" class="btn secondary" type="button">닫기</button>
      </header>
      <ol class="help-list">
        <li><strong>캐릭터 선택</strong>: 상단 카드에서 원하는 캐릭터를 눌러 선택하세요. 여러 개 선택하면 <em>해당 캐릭터를 모두 포함</em>하는 계정만 검색됩니다.</li>
        <li><strong>UID/판매상태/정렬</strong>:
          <ul>
            <li>UID: 판매자가 관리용으로 붙인 고유 번호입니다. 기존에 검색한 매물을 확인할때 유용합니다.</li>
            <li>판매완료 숨기기: 이미 판매된 계정을 리스트에서 숨깁니다.</li>
            <li>정렬: 가격 또는 포함 캐릭터 수 기준으로 오름/내림차순 정렬합니다.</li>
          </ul>
        </li>
        <li><strong>검색 & 확인</strong>: 검색 결과 카드에서 <em>자세히 보기</em>를 통해 포함 아이템과 <strong>가격</strong>, 부가설명을 확인하세요.</li>
        <li><strong>구매 문의</strong>: 판매자 게시글에 적힌 오픈프로필이나 아이디팜을 통해 UID를 보내 문의주세요. 오해 방지를 위해 스크린샷을 함께 보내면 좋습니다.</li>
        <li><strong>주의 사항</strong>:
          <ul>
            <li>계정의 세부적인 아이템과 캐릭터 현황은 실시간으로 일부 변경될 수 있습니다.</li>
            <li>계정 연동 24시간 이후 발생하는 모든 책임은 구매자에게 있습니다.</li>
          </ul>
        </li>
      </ol>
    </div>
  </div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbwGn8yKQfytZpf12BaOZDGluok9iP5DU553Wv2uYN4Qw2flmWc8WLQht0aLZGdZs-FPXQ/exec";
const PLACEHOLDER = "https://dummyimage.com/300x200/e9e9ef/777.png&text=No+Image";

let selected = [];
let itemData = [];
let accountsCache = [];
let lastFiltered = [];

const el = (sel) => document.querySelector(sel);
const safeNum = (v)=> isNaN(Number(v)) ? 0 : Number(v);

function safeImg(url){ if(!url) return PLACEHOLDER; try{ new URL(url) }catch(e){ return PLACEHOLDER }; if(!/^https:/i.test(url)) return PLACEHOLDER; return url; }
async function fetchJSON(url, opts){ const res=await fetch(url,opts); if(!res.ok) throw new Error('API '+res.status); return res.json(); }

async function loadGameTitle(){ try{ const d=await fetchJSON(`${API_BASE}?sheet=game`); el('#game-title').innerText = d[0]?.["게임제목"] || "림버스"; }catch(_){ el('#game-title').innerText="림버스"; }}

async function loadItems(){ const d=await fetchJSON(`${API_BASE}?sheet=items`); itemData = Array.isArray(d)&&d.length? d: []; const box=el('#items'); box.innerHTML='';
  itemData.forEach(it=>{ const b=document.createElement('button'); b.type='button'; b.className='card'; b.dataset.name=it["아이템명"]; b.onclick=()=>toggleSelect(it["아이템명"]);
    b.innerHTML=`<img referrerpolicy="no-referrer" loading="lazy" src="${safeImg(it["이미지URL"])}" alt="${it["아이템명"]}" onerror="this.onerror=null;this.src='${PLACEHOLDER}';"><div class='name'>${it["아이템명"]}</div>`; box.appendChild(b); });
}

function toggleSelect(name){ selected = selected.includes(name)? selected.filter(n=>n!==name): [...selected, name]; renderSelected(); }
function renderSelected(){ el('#selected-items').innerHTML = selected.length? selected.map(n=>`<span class="chip">${n}</span>`).join('') : '아이템을 선택하세요'; el('#search-btn').disabled = selected.length===0;
  document.querySelectorAll('.card').forEach(c=> c.classList.toggle('selected', selected.includes(c.dataset.name)));
}

function applyFilters(accounts){ const q=el('#uid-input').value.trim(); const hideSold=el('#hide-sold').checked;
  return accounts.filter(acc=>{ const values=Object.values(acc); if(!selected.every(s=>values.includes(s))) return false;
    const uid=(acc["UID"]||"")+""; if(q && !uid.includes(q)) return false;
    if(hideSold && (acc["판매상태"]||"").trim()==="판매완료") return false; return true; });
}

function sortResults(arr){ const s=el('#sort-filter').value;
  const withCounts = arr.map(a=>({ a, count: Object.keys(a).filter(k=>k.startsWith('포함아이템') && a[k]).length, price: safeNum(a["가격"]) }));
  if(s==='price_asc') withCounts.sort((x,y)=> x.price - y.price);
  if(s==='price_desc') withCounts.sort((x,y)=> y.price - x.price);
  if(s==='count_asc') withCounts.sort((x,y)=> x.count - y.count);
  if(s==='count_desc') withCounts.sort((x,y)=> y.count - x.count);
  return withCounts.map(x=>x.a);
}

async function searchAccounts(){ accountsCache = await fetchJSON(`${API_BASE}?sheet=accounts`);
  let filtered = applyFilters(accountsCache);
  filtered = sortResults(filtered);
  lastFiltered = filtered;
  renderResults(filtered);
}

function renderResults(list){ const byName=Object.fromEntries(itemData.map(it=>[it["아이템명"], safeImg(it["이미지URL"])])); const box=el('#results'); box.innerHTML='';
  if(list.length===0){ box.innerHTML='<p>조건에 맞는 계정이 없습니다.</p>'; return; }
  list.forEach(acc=>{ const isSold=(acc["판매상태"]||"").trim()==="판매완료"; const priceText = acc["가격"]? ` <span class="price">${acc["가격"]}원</span>`: '';
    const div=document.createElement('div'); div.className='account'+(isSold?' soldout sold-dim':''); div.innerHTML=`<h3>${acc["UID"]} - ${acc["부가설명"]||""}${priceText}</h3>`;
    const thumbs=document.createElement('div'); thumbs.className='thumbs';
    const items=[]; Object.keys(acc).forEach(k=>{ if(k.startsWith('포함아이템') && acc[k]){ items.push(acc[k]); const url=byName[acc[k]]||PLACEHOLDER; const img=new Image(); img.loading='lazy'; img.referrerPolicy='no-referrer'; img.src=url; img.alt=acc[k]; img.onerror=()=>img.src=PLACEHOLDER; thumbs.appendChild(img); } });
    const more=document.createElement('button'); more.className='btn secondary'; more.type='button'; more.textContent='자세히 보기'; more.addEventListener('click',()=>openDetail(acc, items));
    div.appendChild(thumbs); div.appendChild(more); box.appendChild(div); });
}

function openDetail(acc, itemNames){ const byName=Object.fromEntries(itemData.map(it=>[it["아이템명"], safeImg(it["이미지URL"])]));
  el('#detail-title').textContent = `UID ${acc["UID"]}${(acc["판매상태"]||'')==='판매완료'?' · 판매완료':''}`;
  el('#detail-desc').textContent = acc["부가설명"]||'';
  el('#detail-price').textContent = acc["가격"]? `가격: ${acc["가격"]}원` : '';
  const grid=el('#detail-grid'); grid.innerHTML=''; itemNames.forEach(nm=>{ const url=byName[nm]||PLACEHOLDER; const tile=document.createElement('div'); tile.className='tile';
    tile.innerHTML=`<img referrerpolicy="no-referrer" loading="lazy" src="${url}" alt="${nm}" onerror="this.onerror=null;this.src='${PLACEHOLDER}';"><div style="margin-top:6px;font-size:13px;">${nm}</div>`; grid.appendChild(tile); });
  el('#backdrop').style.display='flex';
}

el('#close-modal').addEventListener('click',()=> el('#backdrop').style.display='none');
el('#backdrop').addEventListener('click',(e)=>{ if(e.target.id==='backdrop') el('#backdrop').style.display='none'; });

el('#search-btn').addEventListener('click', searchAccounts);
el('#clear-btn').addEventListener('click', ()=>{ selected=[]; renderSelected(); });
el('#uid-input').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); searchAccounts(); } });
el('#hide-sold').addEventListener('change', ()=>{ if(selected.length>0) searchAccounts(); });
el('#sort-filter').addEventListener('change', ()=>{ if(lastFiltered.length>0) renderResults(sortResults(lastFiltered)); });

el('#help-btn').addEventListener('click', ()=> el('#help-backdrop').style.display='flex');
el('#close-help').addEventListener('click', ()=> el('#help-backdrop').style.display='none');
el('#help-backdrop').addEventListener('click',(e)=>{ if(e.target.id==='help-backdrop') el('#help-backdrop').style.display='none'; });

(async function init(){ await loadGameTitle(); await loadItems(); renderSelected(); })();
</script>
</body>
</html>
