
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>테스트 계정 검색</title>
<style>
  :root { --bg:#fafafa; --fg:#0f172a; --mut:#6b7280; --line:#e5e7eb; --pri:#111827; --back:#ffffffd9; --okbg:#d4edda; --okfg:#155724; --okbd:#c3e6cb; }
  * { box-sizing: border-box; }
  body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); background:var(--bg); }
  header { position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:var(--back); border-bottom:1px solid var(--line); padding:10px 14px; z-index:10; }
  h1 { margin:0; font-size:20px; }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
  input[type=text]{ padding:10px 12px; border:1px solid var(--line); border-radius:10px; min-width:160px; }
  select, button { padding:10px 12px; border:1px solid var(--pri); border-radius:10px; background:var(--pri); color:#fff; font-weight:700; cursor:pointer; }
  select { background:#fff; color:#0f172a; border-color:var(--line); }
  .btn.secondary { background:#fff; color:#0f172a; border:1px solid var(--line); }
  label.chk { display:flex; align-items:center; gap:6px; font-size:13px; color:#6b7280; }
  .counts { margin-left:auto; font-size:13px; color:#374151; }
  .chips { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .chip { background:#f0fdf4; color:#065f46; border:1px solid #bbf7d0; border-radius:999px; padding:4px 8px; font-size:12px; }

  main { padding:12px 14px 90px; }
  .grid { display:grid; gap:10px; }
  @media (max-width:480px) { .grid { grid-template-columns: repeat(5, 1fr); } }
  @media (min-width:481px) and (max-width:900px) { .grid { grid-template-columns: repeat(8, 1fr); } }
  @media (min-width:901px) { .grid { grid-template-columns: repeat(10, 1fr); } }

  .item { border:1px solid var(--line); border-radius:10px; background:#fff; padding:6px; display:flex; flex-direction:column; gap:6px; align-items:center; cursor:pointer; }
  .item img { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; background:#f3f4f6; }
  .item small { color:#6b7280; font-size:11px; text-align:center; }
  .item.selected { outline:3px solid #10b981; outline-offset:2px; }

  .hint { margin:10px 0; color:#6b7280; font-size:13px; }

  .accounts { display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); margin-top:12px; }
  .acc { border:1px solid var(--line); background:#fff; border-radius:12px; padding:12px; }
  .acc h3 { margin:0 0 8px; font-size:16px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
  .acc h3 .uid { font-weight:800; cursor:pointer; }
  .acc h3 .uid:hover { color:#0ea5e9; text-decoration:underline; }
  .price { font-weight:800; color:#111827; }
  .thumbs { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
  .thumbs img { width:48px; height:48px; border-radius:8px; object-fit:cover; background:#f3f4f6; }
  .thumbs .more { font-size:12px; color:#6b7280; }

  .sold { opacity:.55 }
  .pill { padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); color:#374151; background:#f8fafc; }

  .loading { display:none; margin-left:8px; color:#0ea5e9; font-weight:800; }
  .flash { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:var(--okbg); color:var(--okfg); border:1px solid var(--okbd); padding:10px 14px; border-radius:10px; font-weight:800; box-shadow:0 6px 24px rgba(0,0,0,.12); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:200; }
  .flash.on { opacity:1; }

  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px; opacity:0; pointer-events:none; transition:.25s; z-index:60; }
  .toast.on { opacity:1; }

  /* FAB vertical buttons */
  .fab { position:fixed; right:12px; bottom:12px; display:flex; flex-direction:column; gap:10px; z-index:80; }
  .fab a, .fab button { padding:10px 12px; border-radius:999px; font-size:12px; font-weight:800; border:1px solid #0f172a; }
  .fab a { background:#0f172a; color:#fff; text-decoration:none; }
  .fab button { background:#fff; color:#0f172a; }
  .fab a:hover, .fab button:hover { opacity:.9; }
  .fab .mini { font-size:12px; padding:9px 12px; }
  @media (max-width:480px) {
    .fab a, .fab button { font-size:12px; padding:9px 11px; }
  }

  /* Help modal */
  .modal { position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; padding:14px; z-index:100; }
  .modal.on { display:flex; }
  .modal .box { width:min(960px, 96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:14px; border:1px solid var(--line); }
  .modal header { position:sticky; top:0; border-bottom:1px solid var(--line); background:#fff; display:flex; align-items:center; justify-content:space-between; padding:10px 12px; }
  .modal h3 { margin:0; font-size:16px; }
  .modal .close { background:#fff; color:#111827; border:1px solid var(--line); border-radius:10px; padding:8px 10px; cursor:pointer; }
  .help-body { padding:12px 14px 16px; }
  .help-body h2 { margin:0; font-size:18px; }
  .help-list { margin:10px 18px 16px; color:#1f2937; line-height:1.55; }
  .help-list li { margin:6px 0; }
  .help-list ul { margin:6px 0 8px 18px; }
  .help-body em { font-style:normal; color:#111827; font-weight:700; }

  /* Initial overlay spinner */
  .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; gap:12px; background:#ffffff; z-index:120; }
  .spinner { width:26px; height:26px; border-radius:50%; border:3px solid #e5e7eb; border-top-color:#0ea5e9; animation:spin 0.9s linear infinite; }
  .overlay .txt { color:#0f172a; font-weight:800; }
  @keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>
<header>
  <h1>테스트</h1>
  <div class="toolbar">
    <input id="uid-q" type="text" placeholder="UID 검색">
    <select id="sort">
      <option value="">정렬 없음</option>
      <option value="price_desc">가격 높은 순</option>
      <option value="price_asc">가격 낮은 순</option>
      <option value="count_desc">캐릭터 많은 순</option>
      <option value="count_asc">캐릭터 적은 순</option>
    </select>
    <label class="chk"><input type="checkbox" id="hide-sold"> 판매완료 숨기기</label>
    <button id="btn-search">검색</button>
    <button id="btn-clear" class="btn secondary">선택취소</button>
    <span id="loading" class="loading">불러오는 중…</span>
    <div id="counts" class="counts">총 매물 – | 결과 –</div>
  </div>
  <div id="chips" class="chips"></div>
</header>

<main>
  <h2 style="font-size:16px;margin:10px 0 6px;">아이템</h2>
  <div id="items" class="grid"></div>

  <div class="hint" id="hint-acc">검색을 누르면 매물을 불러옵니다.</div>
  <h2 style="font-size:16px;margin:16px 0 6px;">계정</h2>
  <div id="accounts" class="accounts"></div>
</main>

<div id="toast" class="toast">복사됨</div>
<div id="flash" class="flash">검색완료</div>

<!-- FAB Buttons -->
<div class="fab">
  <a id="btn-buy" class="mini" href="#" target="_blank" rel="noopener">구매 문의</a>
  <button id="btn-help" class="mini" type="button">사용 설명서</button>
</div>

<!-- Help Modal -->
<div id="help-modal" class="modal" aria-hidden="true">
  <div class="box">
    <header>
      <h3>사용 설명서</h3>
      <button id="help-close" class="close" type="button">닫기</button>
    </header>
    <div class="help-body">
      <h2>구매 가이드</h2>
      <ol class="help-list">
        <li><strong>캐릭터 선택</strong>: 상단 카드에서 원하는 캐릭터를 눌러 선택하세요. 여러 개 선택하면 <em>해당 캐릭터를 모두 포함</em>하는 계정만 검색됩니다.</li>
        <li><strong>UID/판매상태/정렬</strong>:
          <ul>
            <li>UID: 판매자가 관리용으로 붙인 고유 번호입니다. 일부 숫자만 입력해도 포함 검색됩니다.</li>
            <li>판매완료 숨기기: 이미 판매된 계정을 리스트에서 숨깁니다.</li>
            <li>정렬: 가격 또는 포함 캐릭터 수 기준으로 오름/내림차순 정렬합니다.</li>
          </ul>
        </li>
        <li><strong>검색 & 확인</strong>:
          <ul>
            <li>검색 결과 카드에서 포함 캐릭터와 <strong>가격</strong>, 부가설명을 확인하세요.</li>
            <li>원하는 계정의 uid를 복사한 뒤 판매자의 오픈카카오톡으로 문의하세요.</li>
          </ul>
        </li>
        <li><strong>주의 사항</strong>:
          <ul>
            <li>상세한 캐릭터 목록 및 아이템 현황은 실시간으로 변경될 수 있습니다.</li>
            <li>구매후 24시간 이전에 발생한 문제에 대해서는 보상을 해 드리며, 24시간 이후에 발생한 문제에 대해서는 책임지지 않습니다.</li>
          </ul>
        </li>
      </ol>
    </div>
  </div>
</div>

<!-- Initial overlay -->
<div id="overlay" class="overlay" aria-hidden="false">
  <div class="spinner" aria-hidden="true"></div>
  <div class="txt" aria-live="polite">로딩중</div>
</div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbzUqwzXC4ORsHjYZ_ENyroHXz2G41e0ENMvEiUOreCuiYhnT56f48tSMJmQzbC162rPGA/exec";
const KAKAO = "https://open.kakao.com/o/sENDKZBh";
const PLACEHOLDER = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%' height='100%' fill='%23eef'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='12' fill='%23999'>no image</text></svg>";

function cleanUrl(u){ if(!u) return u; const i=u.indexOf('?'); if(i>0) u=u.slice(0,i); if(/\.jrg$/i.test(u)) u=u.replace(/\.jrg$/i,'.jpg'); return u; }
function el(q){ return document.querySelector(q); }
function h(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; }

let itemsMap = new Map();
let accounts = null; // 처음엔 불러오지 않음
let selected = new Set();

function updateCounts(total, matched){ el('#counts').textContent = `총 매물 ${total ?? '–'} | 결과 ${matched ?? '–'}`; }
function updateChips(){ const box = el('#chips'); box.innerHTML=''; if(selected.size===0) return; selected.forEach(n=> box.appendChild(h(`<span class="chip">{n}</span>`.replace('{n}', n)))); }

function renderItems(list){
  const box = el('#items'); box.innerHTML='';
  list.forEach(it => {
    const name = it['아이템명'] || it['name'] || '';
    const img  = cleanUrl((it['이미지URL'] || it['url'] || '').toString().trim());
    const tpl = `<div class="item" data-name="{name}">
      <img loading="lazy" decoding="async" referrerpolicy="no-referrer" src="{img}" alt="{name}" onerror="this.src='{PH}'">
      <small>{name}</small>
    </div>`;
    const html = tpl.replace(/{name}/g, name).replace(/{img}/g, img || PLACEHOLDER).replace(/{PH}/g, PLACEHOLDER);
    const card = h(html);
    if(selected.has(name)) card.classList.add('selected');
    card.addEventListener('click', ()=>{
      if(selected.has(name)) selected.delete(name); else selected.add(name);
      card.classList.toggle('selected'); updateChips();
    });
    box.appendChild(card);
  });
  // hide initial overlay once items are rendered
  const ov = document.getElementById('overlay');
  if (ov) { ov.style.display = 'none'; ov.setAttribute('aria-hidden','true'); }
}

function itemsFromAccount(acc){
  const arr=[]; for(let i=1;i<=12;i++){ const v=(acc['포함아이템'+i]||'').toString().trim(); if(v) arr.push(v); }
  return arr;
}

function applyFilters(list){
  const q = el('#uid-q').value.trim();
  const hide = el('#hide-sold').checked;
  const want = selected;
  return list.filter(a=>{
    if(q && !String(a['UID']||'').includes(q)) return false;
    if(hide && (a['판매상태']||'')==='판매완료') return false;
    if(want.size){
      const have = new Set(itemsFromAccount(a));
      for(const need of want) if(!have.has(need)) return false;
    }
    return true;
  });
}

function sortResults(list){
  const v = el('#sort').value;
  const ext = list.map(a=>({ a, price:Number(a['가격']||0), cnt:itemsFromAccount(a).length }));
  if(v==='price_desc') ext.sort((x,y)=>y.price-x.price);
  if(v==='price_asc')  ext.sort((x,y)=>x.price-y.price);
  if(v==='count_desc') ext.sort((x,y)=>y.cnt-x.cnt);
  if(v==='count_asc')  ext.sort((x,y)=>x.cnt-y.cnt);
  return ext.map(x=>x.a);
}

function showToast(msg='복사됨'){
  const t = el('#toast'); t.textContent = msg;
  t.classList.add('on');
  setTimeout(()=> t.classList.remove('on'), 1100);
}

function flashDone(){
  let f = document.getElementById('flash');
  if(!f){
    f = h('<div id="flash" class="flash">검색완료</div>');
    document.body.appendChild(f);
  }
  f.classList.add('on');
  clearTimeout(f._t);
  f._t = setTimeout(()=> f.classList.remove('on'), 650);
}

function setLoading(on){
  el('#loading').style.display = on ? 'inline-block' : 'none';
}

function renderAccounts(list){
  const box = el('#accounts'); box.innerHTML='';
  if(!list.length){ box.innerHTML = '<p class="chip" style="background:#fff;border-color:#e5e7eb;color:#6b7280;">조건에 맞는 계정이 없습니다.</p>'; updateCounts(accounts?.length||0, 0); return; }
  list.forEach(acc=>{
    const names = itemsFromAccount(acc);
    const thumbs = names.slice(0,8).map(n=>{
      const url = cleanUrl(itemsMap.get(n)||PLACEHOLDER);
      return `<img loading="lazy" decoding="async" src="${url||PLACEHOLDER}" alt="${n}" title="${n}" onerror="this.src='${PLACEHOLDER}'">`;
    }).join('');
    const more = names.length>8 ? `<span class="more">+${names.length-8}</span>` : '';
    const sold = (acc['판매상태']||'')==='판매완료';
    const price = Number(acc['가격']||0).toLocaleString('ko-KR');
    const uid = acc['UID']||'';
    const desc = acc['부가설명']||'';
    const card = h(`<div class="acc ${sold?'sold':''}">
      <h3><span class="uid" title="탭하면 복사">${uid}</span><span class="price">${price}원</span></h3>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <span class="pill">${sold?'판매완료':'판매중'}</span>
        <span class="mut">${desc}</span>
        <span class="mut">· 아이템 ${names.length}개</span>
      </div>
      <div class="thumbs">${thumbs}${more}</div>
    </div>`);
    card.querySelector('.uid').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(uid); showToast('UID 복사됨'); }catch{ showToast('복사 실패'); }
    });
    box.appendChild(card);
  });
  updateCounts(accounts.length, list.length);
}

async function fetchJSON(url){
  const r = await fetch(url, { headers: { 'Content-Type':'text/plain;charset=utf-8' } });
  const txt = await r.text();
  try{ return JSON.parse(txt); }catch(e){ throw new Error('JSON parse error: '+txt.slice(0,200)); }
}

async function loadItems(){
  const list = await fetchJSON(API_BASE + "?sheet=items");
  itemsMap = new Map(list.map(it=>[it['아이템명']||it['name'], (it['이미지URL']||it['url']||'').toString().trim()]));
  renderItems(list);
}

async function loadAccountsIfNeeded(){
  if (accounts) return accounts;
  const list = await fetchJSON(API_BASE + "?sheet=accounts");
  accounts = list;
  return accounts;
}

async function runSearch(){
  setLoading(true);
  el('#hint-acc').style.display = 'none';
  try {
    await loadAccountsIfNeeded();
    const filtered = sortResults(applyFilters(accounts));
    renderAccounts(filtered);
  } catch (e) {
    console.warn(e);
  } finally {
    setLoading(false);
    flashDone();
  }
}

[['#sort','change'],['#uid-q','input'],['#hide-sold','change']].forEach(([q,evt])=>{
  const node=el(q); if(!node) return;
  node.addEventListener(evt, ()=>{ if(accounts){ renderAccounts(sortResults(applyFilters(accounts))); } });
});

el('#btn-search').addEventListener('click', runSearch);
el('#btn-clear').addEventListener('click', ()=>{
  selected.clear(); updateChips(); renderItems(Array.from(itemsMap, ([아이템명, 이미지URL])=>({아이템명, 이미지URL})));
  if (accounts){ renderAccounts(sortResults(applyFilters(accounts))); }
});

// FAB actions
document.getElementById('btn-buy').setAttribute('href', KAKAO);
document.getElementById('btn-help').addEventListener('click', ()=>{
  const m = document.getElementById('help-modal');
  m.classList.add('on'); m.setAttribute('aria-hidden','false');
});
document.getElementById('help-close').addEventListener('click', ()=>{
  const m = document.getElementById('help-modal');
  m.classList.remove('on'); m.setAttribute('aria-hidden','true');
});
document.getElementById('help-modal').addEventListener('click', (e)=>{
  if(e.target.id==='help-modal'){ const m=e.currentTarget; m.classList.remove('on'); m.setAttribute('aria-hidden','true'); }
});

// 최초: 아이템만 로드
loadItems();
updateCounts(undefined, undefined);
</script>
</body>
</html>
