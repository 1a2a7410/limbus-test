
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>테스트 계정 검색</title>
<style>
  :root { --bg:#fafafa; --fg:#0f172a; --mut:#6b7280; --line:#e5e7eb; --pri:#111827; --back:#ffffffd9; --accent:#0ea5e9; --sel:#10b981; }
  * { box-sizing: border-box; }
  body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); background:#fafafa; }
  header { position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:var(--back); border-bottom:1px solid var(--line); padding:10px 14px; z-index:10; }
  h1 { margin:0; font-size:20px; }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
  input[type=text]{ padding:10px 12px; border:1px solid var(--line); border-radius:10px; min-width:160px; }
  select, button { padding:10px 12px; border:1px solid var(--pri); border-radius:10px; background:var(--pri); color:#fff; font-weight:700; cursor:pointer; }
  select { background:#fff; color:#0f172a; border-color:var(--line); }
  label.chk { display:flex; align-items:center; gap:6px; font-size:13px; color:#6b7280; }
  .counts { margin-left:auto; font-size:13px; color:#374151; }
  .chips { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .chip { background:#f0fdf4; color:#065f46; border:1px solid #bbf7d0; border-radius:999px; padding:4px 8px; font-size:12px; }
  main { padding:12px 14px 120px; }
  .grid { display:grid; gap:10px; }
  @media (max-width:480px) { .grid { grid-template-columns: repeat(5, 1fr); } }
  @media (min-width:481px) and (max-width:900px) { .grid { grid-template-columns: repeat(8, 1fr); } }
  @media (min-width:901px) { .grid { grid-template-columns: repeat(10, 1fr); } }
  .hint { color:#6b7280; padding:10px 0 0; }
  .item { border:1px solid var(--line); border-radius:10px; background:#fff; padding:6px; display:flex; flex-direction:column; gap:6px; align-items:center; cursor:pointer; }
  .item img { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; background:#f3f4f6; }
  .item small { color:#6b7280; font-size:11px; text-align:center; }
  .item.selected { outline:3px solid var(--sel); outline-offset:2px; }
  .accounts { display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); margin-top:12px; }
  .acc { border:1px solid var(--line); background:#fff; border-radius:12px; padding:12px; }
  .acc h3 { margin:0 0 8px; font-size:16px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
  .acc h3 .uid { font-weight:800; cursor:pointer; }
  .acc h3 .uid:hover { color:#0ea5e9; text-decoration:underline; }
  .price { font-weight:800; color:#111827; }
  .thumbs { display:flex; gap:6px; flex-wrap:wrap; }
  .thumbs img { width:48px; height:48px; border-radius:8px; object-fit:cover; background:#f3f4f6; }
  .more-thumbs { font-size:12px; color:#6b7280; }
  .sold { opacity:.55 }
  .pill { padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); color:#374151; background:#f8fafc; }
  .mut { color:#6b7280; }
  .btn.primary { background:#0f172a; color:#fff; }
  .btn.secondary { background:#fff; color:#0f172a; }
  .btn.small { padding:6px 8px; font-size:12px; border-radius:8px; }
  .btn-group { display:flex; gap:8px; flex-wrap:wrap; }
  .fab { position:fixed; right:12px; bottom:12px; display:flex; flex-direction:column; gap:10px; z-index:50; }
  .fab .btn-lg { padding:10px 12px; border-radius:999px; font-size:12px; border:1px solid #0f172a; background:#0f172a; color:#fff; font-weight:800; }
  .fab .btn-lg.secondary { background:#fff; color:#0f172a; }
  .modal { position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; padding:14px; z-index:100; }
  .modal.on { display:flex; }
  .modal .box { width:min(960px, 96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:14px; border:1px solid var(--line); }
  .modal header { position:sticky; top:0; border-bottom:1px solid var(--line); background:#fff; display:flex; align-items:center; justify-content:space-between; padding:10px 12px; }
  .modal h3 { margin:0; font-size:16px; }
  .modal .close { background:#fff; color:#111827; border:1px solid var(--line); }
  .detail { padding:12px; }
  .detail .grid { grid-template-columns: repeat(auto-fill, minmax(100px,1fr)); gap:12px; }
  .detail .card { border:1px solid var(--line); border-radius:10px; padding:8px; text-align:center; background:#fff; }
  .detail .card img { width:88px; height:88px; object-fit:cover; border-radius:8px; display:block; margin:0 auto 6px; }
  .detail .card small { display:block; font-size:12px; color:#374151; }
  .help-body { padding:12px 14px 16px; }
  .help-body h2 { margin:0; font-size:18px; }
  .help-list { margin:10px 18px 16px; color:#1f2937; line-height:1.55; }
  .help-list li { margin:6px 0; }
  .help-list ul { margin:6px 0 8px 18px; }
  .help-body em { font-style:normal; color:#111827; font-weight:700; }
  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px; opacity:0; pointer-events:none; transition:.25s; z-index:60; }
  .toast.on { opacity:1; }
  .flash { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    background:#d4edda; color:#155724; border:1px solid #c3e6cb;
    padding:10px 14px; border-radius:10px; font-weight:800;
    box-shadow:0 6px 24px rgba(0,0,0,.12);
    opacity:0; pointer-events:none; transition: opacity .25s ease; z-index:200; }
  .flash.on { opacity:1; }
  .spinner { display:inline-flex; gap:4px; align-items:center; color:#374151; font-size:13px; }
  .dot { width:6px; height:6px; border-radius:50%; background:#9ca3af; animation:b 1s infinite alternate; }
  .dot:nth-child(2){ animation-delay:.15s;} .dot:nth-child(3){ animation-delay:.3s;}
  @keyframes b { from{opacity:.2; transform:translateY(0)} to{opacity:1; transform:translateY(-2px)} }
  .sentinel { height: 1px; }
</style>
</head>
<body>
<header>
  <h1>테스트</h1>
  <div class="toolbar">
    <input id="uid-q" type="text" placeholder="UID 검색">
    <select id="sort">
      <option value="">정렬 없음</option>
      <option value="price_desc">가격 높은 순</option>
      <option value="price_asc">가격 낮은 순</option>
      <option value="count_desc">캐릭터 많은 순</option>
      <option value="count_asc">캐릭터 적은 순</option>
    </select>
    <label class="chk"><input type="checkbox" id="hide-sold"> 판매완료 숨기기</label>
    <div class="btn-group">
      <button id="btn-search" class="btn primary">검색</button>
      <button id="btn-clear" class="btn secondary">선택취소</button>
    </div>
    <div id="counts" class="counts">총 매물 – | 결과 –</div>
  </div>
  <div id="chips" class="chips"></div>
</header>

<main>
  <div id="pre-hint" class="hint">필터 선택 후 <b>검색</b>을 누르면 매물을 불러옵니다.</div>

  <h2 style="font-size:16px;margin:10px 0 6px;">아이템</h2>
  <div id="items" class="grid"></div>

  <h2 style="font-size:16px;margin:16px 0 6px;">계정</h2>
  <div id="accounts" class="accounts"></div>
  <div id="sentinel" class="sentinel"></div>
</main>

<!-- 상세보기 모달 -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <header>
      <h3 id="modal-title">상세보기</h3>
      <button class="close" id="modal-close" type="button">닫기</button>
    </header>
    <div class="detail">
      <div id="detail-grid" class="grid"></div>
    </div>
  </div>
</div>

<!-- 도움/문의 플로팅 버튼은 이전과 동일하게 필요시 추가 가능 -->

<div id="toast" class="toast">복사됨</div>
<div id="flash" class="flash">검색완료</div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbzUqwzXC4ORsHjYZ_ENyroHXz2G41e0ENMvEiUOreCuiYhnT56f48tSMJmQzbC162rPGA/exec";
const PAGE_SIZE = 30;
const MAX_THUMBS = 8;
const PLACEHOLDER = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%' height='100%' fill='%23eef'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='12' fill='%23999'>no image</text></svg>";

// sanitize URL
function cleanUrl(u){
  if(!u) return u;
  const q = u.indexOf('?');
  if (q > -1) u = u.slice(0, q);
  if (/\.(jrg)$/i.test(u)) u = u.replace(/\.(jrg)$/i, '.jpg');
  return u;
}

// lazy loader
const io = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      const el = e.target;
      const src = el.getAttribute('data-src');
      if(src){ el.src = src; el.removeAttribute('data-src'); }
      io.unobserve(el);
    }
  });
}, { rootMargin: "400px" });

function lazyImg(img){
  if(!img) return;
  if('loading' in HTMLImageElement.prototype){
    // browser native lazy loading still uses src, keep data-src for fallback
  }
  io.observe(img);
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function j(url, opt={}, tries=2){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 12000);
  try{
    const u = url + (url.includes("?") ? "&" : "?") + "_v=" + Date.now();
    const r = await fetch(u, { ...opt, headers: {'Content-Type':'text/plain;charset=utf-8'}, signal: ctrl.signal });
    const txt = await r.text();
    try { const json = JSON.parse(txt); if(!r.ok || json.error) throw json; return json; }
    catch(e) { throw txt || e; }
  }catch(e){
    if(tries>0){ await sleep(400); return j(url,opt,tries-1); }
    throw e;
  }finally{ clearTimeout(t); }
}

let itemsLoaded = false;
let accountsLoaded = false;
let itemMap = new Map();
let accounts = [];
let selected = new Set();
let currentFiltered = [];
let page = 0;

function el(q){ return document.querySelector(q); }
function h(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; }
function showFlash(){ const f = el('#flash'); f.classList.add('on'); setTimeout(()=>f.classList.remove('on'), 600); }
function showToast(msg='복사됨'){ const t = el('#toast'); t.textContent = msg; t.classList.add('on'); setTimeout(()=> t.classList.remove('on'), 1100); }
function updateCounts(total, matched){ el('#counts').textContent = `총 매물 ${total} | 결과 ${matched}`; }

function updateChips(){
  const box = el('#chips'); box.innerHTML = '';
  if(selected.size===0) return;
  selected.forEach(name=>{ box.appendChild(h(`<span class="chip">${name}</span>`)); });
}

function itemsFromAccount(acc){
  const arr = [];
  for(let i=1;i<=12;i++){ const v = (acc["포함아이템"+i]||"").toString().trim(); if(v) arr.push(v); }
  return arr;
}

function accountMatchesSelected(acc){
  if(selected.size===0) return true;
  const have = new Set(itemsFromAccount(acc));
  for(const need of selected) if(!have.has(need)) return false;
  return true;
}

function applyFilters(list){
  const q = el('#uid-q').value.trim();
  const hide = el('#hide-sold').checked;
  return list.filter(a=>{
    if(q && !String(a["UID"]||"").includes(q)) return false;
    if(hide && (a["판매상태"]||"") === "판매완료") return false;
    if(!accountMatchesSelected(a)) return false;
    return true;
  });
}

function sortResults(list){
  const v = el('#sort').value;
  const ext = list.map(a=>({ a, price: Number(a["가격"]||0), cnt: itemsFromAccount(a).length }));
  if(v==='price_desc') ext.sort((x,y)=> y.price - x.price);
  if(v==='price_asc')  ext.sort((x,y)=> x.price - y.price);
  if(v==='count_desc') ext.sort((x,y)=> y.cnt - x.cnt);
  if(v==='count_asc')  ext.sort((x,y)=> x.cnt - y.cnt);
  return ext.map(x=>x.a);
}

function renderItemsFromAccounts(){
  const s = new Set();
  accounts.forEach(a => { for (let i=1;i<=12;i++){ const v=(a["포함아이템"+i]||"").toString().trim(); if(v) s.add(v); } });
  const list = Array.from(s).map(n => ({ "아이템명": n, "이미지URL": (itemMap.get(n)||"") }));
  const box = el('#items'); box.innerHTML = '';
  list.forEach(it=>{
    const imgUrl = cleanUrl((it["이미지URL"]||"").toString().trim());
    const name = it["아이템명"];
    const card = h(`<div class="item" data-name="${name}">
      <img loading="lazy" decoding="async" referrerpolicy="no-referrer" data-src="${imgUrl||PLACEHOLDER}" alt="${name||''}" onerror="this.src='${PLACEHOLDER}'">
      <small>${name||''}</small>
    </div>`);
    if(selected.has(name)) card.classList.add('selected');
    card.addEventListener('click', ()=>{ 
      if(selected.has(name)) selected.delete(name); else selected.add(name);
      card.classList.toggle('selected');
      updateChips();
    });
    box.appendChild(card);
    lazyImg(card.querySelector('img'));
  });
}

function renderPage(chunk){
  const box = el('#accounts');
  chunk.forEach(acc=>{
    const names = itemsFromAccount(acc);
    const thumbs = names.slice(0, MAX_THUMBS).map(n=>{
      const url = cleanUrl(itemMap.get(n) || PLACEHOLDER);
      return `<img loading="lazy" decoding="async" data-src="${url}" alt="${n}" onerror="this.src='${PLACEHOLDER}'" title="${n}">`;
    }).join('');
    const more = names.length > MAX_THUMBS ? `<span class="more-thumbs">+${names.length - MAX_THUMBS}</span>` : '';
    const sold = (acc["판매상태"]||"") === "판매완료";
    const price = Number(acc["가격"]||0).toLocaleString('ko-KR');
    const desc = (acc["부가설명"]||"");
    const uid = (acc["UID"]||"");
    const card = h(`
      <div class="acc ${sold?'sold':''}">
        <h3>
          <span class="uid" data-uid="${uid}" title="탭하면 복사">${uid}</span>
          <span class="price">${price}원</span>
        </h3>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <span class="pill">${sold?'판매완료':'판매중'}</span>
          <span class="mut">${desc}</span>
          <span class="mut">· 아이템 ${names.length}개</span>
          <button class="btn small detail-btn" data-uid="${uid}">상세보기</button>
        </div>
        <div class="thumbs">${thumbs} ${more}</div>
      </div>
    `);
    card.querySelector('.uid').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(uid); showToast('UID 복사됨'); }catch{ showToast('복사 실패'); } });
    card.querySelector('.detail-btn').addEventListener('click', ()=> openModal(acc));
    box.appendChild(card);
    // lazy observe thumbs
    card.querySelectorAll('img[data-src]').forEach(lazyImg);
  });
}

function resetList(){
  el('#accounts').innerHTML = '';
  page = 0;
}

function paginateAndRender(){
  const start = page * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const slice = currentFiltered.slice(start, end);
  renderPage(slice);
  page++;
}

function attachInfiniteScroll(){
  const sentinel = document.getElementById('sentinel');
  if (attachInfiniteScroll._observer) attachInfiniteScroll._observer.disconnect();
  attachInfiniteScroll._observer = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if (e.isIntersecting){
        const loaded = page * PAGE_SIZE;
        if (loaded < currentFiltered.length){
          paginateAndRender();
        }
      }
    });
  }, { rootMargin: "600px" });
  attachInfiniteScroll._observer.observe(sentinel);
}

function openModal(acc){
  const names = itemsFromAccount(acc);
  const grid = el('#detail-grid'); grid.innerHTML = '';
  names.forEach(n=>{
    const url = cleanUrl(itemMap.get(n)||PLACEHOLDER);
    const node = h(`
      <div class="card">
        <img loading="lazy" decoding="async" data-src="${url}" alt="${n}" onerror="this.src='${PLACEHOLDER}'">
        <small>${n}</small>
      </div>
    `);
    grid.appendChild(node);
    lazyImg(node.querySelector('img'));
  });
  el('#modal-title').textContent = `${acc["UID"]||""} 상세보기`;
  el('#modal').classList.add('on');
  el('#modal').setAttribute('aria-hidden','false');
}
function closeModal(){ el('#modal').classList.remove('on'); el('#modal').setAttribute('aria-hidden','true'); }

async function loadItemsOnce(){
  if (itemsLoaded) return;
  try{
    const items = await j(API_BASE + "?sheet=items");
    itemMap = new Map(items.map(it=>[it["아이템명"], cleanUrl((it["이미지URL"]||"").toString().trim())]));
    itemsLoaded = true;
  }catch(e){ console.warn('items load failed', e); itemMap = new Map(); itemsLoaded = true; }
}

async function loadAccountsOnce(){
  if (accountsLoaded) return;
  try{
    accounts = await j(API_BASE + "?sheet=accounts");
    accountsLoaded = true;
  }catch(e){ console.warn('accounts load failed', e); accounts = []; accountsLoaded = true; }
}

async function firstSearch(){
  el('#pre-hint').innerHTML = '<span class="spinner"><span class="dot"></span><span class="dot"></span><span class="dot"></span> 불러오는 중…</span>';
  await Promise.all([loadItemsOnce(), loadAccountsOnce()]);
  renderItemsFromAccounts();
  runSearch();
}

function runSearch(){
  currentFiltered = sortResults(applyFilters(accounts));
  resetList();
  paginateAndRender();
  updateCounts(accounts.length, currentFiltered.length);
  showFlash();
}

[['#sort','change'], ['#uid-q','input'], ['#hide-sold','change']].forEach(([q,evt])=>{
  const node = el(q); if(!node) return;
  node.addEventListener(evt, ()=>{ if(!accountsLoaded) return; runSearch(); });
});

document.getElementById('btn-search').addEventListener('click', ()=>{
  if(!accountsLoaded){ firstSearch().then(attachInfiniteScroll); }
  else { runSearch(); }
});

document.getElementById('btn-clear').addEventListener('click', ()=>{
  selected.clear(); updateChips();
  if(accountsLoaded){
    renderItemsFromAccounts();
    runSearch();
  }
});

document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
document.getElementById('modal-close').addEventListener('click', closeModal);
document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });
</script>
</body>
</html>
